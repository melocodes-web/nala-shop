<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ankletproduct</title>
  <style>
    :root { --accent:#e60023; --bg:#fafafa; --card-bg:#fff; --muted:#666; }
    body { font-family: Arial, sans-serif; margin:20px; background:var(--bg); color:#222; }
    header { display:flex; justify-content:space-between; align-items:center; max-width:1100px; margin:0 auto 16px; }
    header a { color:#333; text-decoration:none; font-weight:600; }
    .cart-link { background:#fff; padding:8px 12px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.06); }
    .wrap { max-width:1100px; margin:0 auto; display:flex; gap:30px; flex-wrap:wrap; align-items:flex-start; }

    /* Galerie */
    .gallery { flex:1 1 480px; background:var(--card-bg); padding:14px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
    .main { position:relative; overflow:hidden; border-radius:8px; background:#f6f6f6; }
    .main img { width:100%; height:auto; display:block; object-fit:contain; margin:0; }
    .thumbs { display:flex; gap:8px; margin-top:10px; overflow-x:auto; padding-bottom:6px; align-items:center; }
    .thumbs img { width:70px; height:70px; object-fit:cover; border-radius:6px; cursor:pointer; border:2px solid transparent; }
    .thumbs img.active { border-color:var(--accent); box-shadow:0 0 0 3px rgba(230,0,35,0.12); }

    .nav-arrow { position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.35); color:#fff; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:5; }
    .nav-left { left:10px; } .nav-right { right:10px; }

    /* Info */
    .info { flex:1 1 380px; max-width:420px; background:var(--card-bg); padding:18px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
    .info h1 { margin:0 0 8px 0; font-size:22px; }
    .price { color:var(--accent); font-weight:700; margin-bottom:12px; font-size:18px; }
    .desc { line-height:1.5; color:#444; margin-bottom:12px; }
    .sizes { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .sizes input { padding:8px; border-radius:6px; border:1px solid #888; width:140px; }

    .variant-checkbox { display:inline-flex; gap:8px; align-items:center; padding:6px 8px; border-radius:8px; border:1px solid #eee; cursor:pointer; background:#fff; }
    .variant-checkbox input[type=checkbox] { transform:scale(1.05); }
    .qty-input { width:64px; padding:6px; border-radius:6px; border:1px solid #ccc; text-align:center; }

    .cta { display:flex; gap:10px; align-items:center; }
    .buy { background:var(--accent); color:#fff; border:none; padding:12px 18px; border-radius:8px; cursor:pointer; font-weight:700; }
    .back { background:#eee; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }

    .muted { color:var(--muted); font-size:14px; }

    .format-warning { color:#a00; font-size:13px; margin-top:6px; }

    @media (max-width:900px) {
      header, .wrap { padding:0 12px; }
      .wrap { flex-direction:column; }
      .variant-checkbox { width:100%; justify-content:space-between; }
    }
  </style>
</head>
<body>
  <header>
    <a href="anklethomepage.html">← Back to previous page</a>
    <a class="cart-link" href="cart.html">Cart (<span id="cartCount">0</span>)</a>
  </header>

  <div class="wrap" id="wrap">
    <div class="gallery">
      <div class="main" id="mainContainer">
        <div class="nav-arrow nav-left" id="leftBtn" aria-label="Zurück">&#10094;</div>
        <img id="mainImg" src="images/placeholder.jpg" alt="Produktbild">
        <div class="nav-arrow nav-right" id="rightBtn" aria-label="Vor">&#10095;</div>
      </div>
      <div class="thumbs" id="thumbs"></div>
      <div id="formatNotice" class="format-warning" style="display:none;"></div>
    </div>

    <div class="info" id="info">
      <h1 id="title">Productname</h1>
      <div class="price" id="price">Rwf</div>
      <div class="desc" id="desc">Description</div>

      <div>
        <strong>Inches (write measurement):</strong>
        <div class="sizes" id="sizeBox" style="margin-top:8px;">
          <input id="inchInput" type="text" placeholder="z. B. 7.5" />
          <small class="muted" style="align-self:center;">Enter inches (e.g. 7 or 7.5)</small>
        </div>
      </div>

      <!-- Varianten + Mengen -->
      <div style="margin:10px 0;">
        <strong>Choose the Anklet variants:</strong>

        <!-- Checkboxen + Mengen für Varianten -->
        <div id="variantCheckboxes" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;"></div>

        <small class="muted" style="display:block; margin-top:6px;">(The first picture is the main variant and isn't shown as a checkbox.)</small>
      </div>

      <div style="margin-top:12px" id="availability"></div>

      <div style="margin-top:14px" class="cta">
        <button class="buy" id="addToCart">In the Cart</button>
        <button class="back" onclick="location.href='anklethomepage.html'">Back</button>
      </div>

    </div>
  </div>

  <script>
    // ---------- Konfiguration ----------
    const apiUrl = "https://script.google.com/macros/s/AKfycbyMoVpx7fjt6yJV3l3iVDaDxLYWW2xwrFgruXIQnpZ8P-O088sG-eRdB7r2Tzu8MlvGVA/exec";
    const id = new URLSearchParams(window.location.search).get("id");

    // ---------- Warenkorb ----------
    const CART_KEY = "nala_cart_v1";
    function getCart(){ const raw = localStorage.getItem(CART_KEY); return raw ? JSON.parse(raw) : []; }
    function saveCart(cart){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); updateCartCount(); }
    function addToCart(item){
      const cart = getCart();
      // identische Position = gleiche id + variantIndex + measurement
      const found = cart.find(c => c.id === item.id && c.variantIndex === item.variantIndex && c.size === item.size);
      if(found){ found.qty = Number(found.qty) + Number(item.qty); }
      else cart.push(item);
      saveCart(cart);
    }
    function updateCartCount(){
      const el = document.getElementById("cartCount");
      if(!el) return;
      const total = getCart().reduce((s,i)=> s + Number(i.qty||0), 0);
      el.textContent = total;
    }
    updateCartCount();

    // ---------- Helper ----------
    function toArray(val){
      if(val === undefined || val === null) return [];
      if(Array.isArray(val)) return val;
      if(typeof val === "string"){
        try { const parsed = JSON.parse(val); if(Array.isArray(parsed)) return parsed; } catch(e){}
        return val.split(/\s*,\s*|\r?\n/).map(x=>x.trim()).filter(Boolean);
      }
      return [];
    }

    function ensureCloudinaryAuto(url){
      if(!url) return url;
      if(url.includes("/upload/") && !url.includes("/upload/f_auto")) return url.replace("/upload/", "/upload/f_auto,q_auto/");
      return url;
    }

    // Versucht alternative URLs wenn ein Bild nicht geladen werden kann.
    // Ersetzt .heic/.heif → .jpg/.png, fügt ggf. ?raw=1 hinzu
    function makeAlternateCandidates(src){
      const candidates = [];
      try {
        const u = new URL(src, window.location.href).href;
        // try the original first
        candidates.push(u);

        // If heic/heif extension => try jpg/png
        if(/\.(heic|heif)$/i.test(u)){
          candidates.push(u.replace(/\.(heic|heif)$/i, ".jpg"));
          candidates.push(u.replace(/\.(heic|heif)$/i, ".png"));
        }

        // If url doesn't contain extension, try adding jpg/png raw variants
        if(!/\.\w{2,5}($|\?)/.test(u)){
          candidates.push(u + ".jpg");
          candidates.push(u + ".png");
        }

        // try adding raw query param (useful for some drive links)
        if(!u.includes("raw=1")) candidates.push(u + (u.includes('?') ? '&' : '?') + 'raw=1');
      } catch(e){
        // fallback: return raw src and jpg/png guesses
        candidates.push(src);
        candidates.push(src.replace(/\.(heic|heif)$/i, ".jpg"));
        candidates.push(src.replace(/\.(heic|heif)$/i, ".png"));
      }
      // dedupe
      return Array.from(new Set(candidates));
    }

    // set image with fallback candidates; shows unsupported placeholder if all fail
    function setImgWithFallback(imgEl, src, onFailNotice){
      const candidates = makeAlternateCandidates(src);
      let i = 0;
      imgEl.onerror = function(){
        i++;
        if(i < candidates.length){
          imgEl.src = candidates[i];
        } else {
          // all failed — set placeholder and optionally show notice
          imgEl.src = "images/placeholder.jpg";
          if(onFailNotice) onFailNotice();
        }
      };
      // start with first candidate
      imgEl.src = candidates[0];
    }

    // ---------- Page logic ----------
    if(!id){
      document.getElementById("wrap").innerHTML = "<p>No Product Id found.</p>";
    } else {
      fetch(`${apiUrl}?id=${encodeURIComponent(id)}`)
        .then(res => res.json())
        .then(p => {
          if(!p || p.error){
            document.getElementById("wrap").innerHTML = "<p>Product not found.</p><p><a href='anklethomepage.html'>Back</a></p>";
            return;
          }

          const prod = {
            id: p.id || p.ID || p.name || p.Name || ("prod-" + Math.random().toString(36).slice(2,8)),
            name: p.name || p.Name || "",
            price: (p.price ?? p.preis ?? 0),
            description: p.description || p.beschreibung || "",
            availability: (p.availability ?? p.verfügbar ?? true),
            sizes: toArray(p.sizes || p.größen || []),
            images: toArray(p.images || p.bilder || []).map(s => ensureCloudinaryAuto(s))
          };

          // fill UI
          document.getElementById("title").textContent = prod.name || "Kein Name";
          document.getElementById("price").textContent = "Rwf " + (Number(prod.price) || 0);
          document.getElementById("desc").textContent = prod.description || "";
          document.getElementById("availability").innerHTML = prod.availability ? "<strong style='color:green'>In Stock</strong>" : "<strong style='color:red'>Sold out</strong>";

          // inches input (already in DOM)
          const inchInput = document.getElementById("inchInput");
          if(prod.sizes && prod.sizes.length){
            // if sheet has suggested measurements, show as placeholder options (join)
            inchInput.placeholder = prod.sizes.join(", ");
          }

          // Gallery + variants
          const mainImg = document.getElementById("mainImg");
          const thumbs = document.getElementById("thumbs");
          const variantCheckboxes = document.getElementById("variantCheckboxes");
          const leftBtn = document.getElementById("leftBtn");
          const rightBtn = document.getElementById("rightBtn");
          const formatNotice = document.getElementById("formatNotice");

          let images = prod.images.slice();
          if(images.length === 0) images = ["images/placeholder.jpg"];
          let current = 0;

          function populateVariantsAndThumbs(){
            thumbs.innerHTML = "";
            variantCheckboxes.innerHTML = "";
            formatNotice.style.display = "none";

            images.forEach((src, i) => {
              const t = document.createElement("img");
              t.alt = "Vorschaubild " + (i+1);
              setImgWithFallback(t, src, () => {
                // show small notice once if any candidate failed
                formatNotice.textContent = "Einige Bilder konnten nicht im Browserformat geladen werden. Bitte lade eine JPG/PNG/WebP-Version hoch, wenn möglich.";
                formatNotice.style.display = "block";
              });
              t.className = i === current ? "active" : "";
              t.onclick = () => {
                current = i;
                renderGallery();
                // toggle checkbox if exists (not for index 0)
                const cb = variantCheckboxes.querySelector(`input[data-index='${i}']`);
                if(cb) {
                  cb.checked = !cb.checked;
                  const qty = document.getElementById(`qty_${i}`);
                  if(qty) qty.disabled = !cb.checked;
                }
              };
              thumbs.appendChild(t);
            });

            // create variant controls for i>=1 (and also for i==0 we add a qty input below if you want)
            images.forEach((src, i) => {
              if(i === 0){
                // for main image: give a qty input shown inline with label
                const wrapper = document.createElement("div");
                wrapper.style.display = "inline-flex";
                wrapper.style.alignItems = "center";
                wrapper.style.gap = "8px";
                wrapper.style.marginRight = "8px";

                const label = document.createElement("label");
                label.style.fontWeight = "600";
                label.textContent = "Qty (main):";

                const qty0 = document.createElement("input");
                qty0.type = "number";
                qty0.min = "1";
                qty0.value = "1";
                qty0.id = "qty_0";
                qty0.className = "qty-input";

                wrapper.appendChild(label);
                wrapper.appendChild(qty0);
                variantCheckboxes.appendChild(wrapper);
                return;
              }

              const wrapper = document.createElement("label");
              wrapper.className = "variant-checkbox";
              wrapper.style.display = "inline-flex";
              wrapper.style.alignItems = "center";
              wrapper.style.gap = "8px";

              const cb = document.createElement("input");
              cb.type = "checkbox";
              cb.dataset.index = String(i);

              const span = document.createElement("span");
              span.textContent = "Picture " + (i+1);

              const qty = document.createElement("input");
              qty.type = "number";
              qty.min = "1";
              qty.value = "1";
              qty.id = `qty_${i}`;
              qty.className = "qty-input";
              qty.disabled = true;

              cb.addEventListener("change", () => {
                qty.disabled = !cb.checked;
                const imgs = thumbs.querySelectorAll("img");
                const imgEl = imgs[i];
                if(imgEl) imgEl.style.boxShadow = cb.checked ? "0 0 0 3px rgba(230,0,35,0.12)" : "";
              });

              wrapper.appendChild(cb);
              wrapper.appendChild(span);
              wrapper.appendChild(qty);

              variantCheckboxes.appendChild(wrapper);
            });
          }

          function renderGallery(){
            if(!images.length) return;
            // set main image using fallback logic
            setImgWithFallback(mainImg, images[current], () => {
              formatNotice.textContent = "Hauptbild nicht in unterstütztem Browserformat. Bitte JPG/PNG/WebP bereitstellen.";
              formatNotice.style.display = "block";
            });

            const imgs = thumbs.querySelectorAll("img");
            imgs.forEach((img, idx) => {
              img.classList.toggle("active", Number(idx) === Number(current));
              const cb = variantCheckboxes.querySelector(`input[data-index='${idx}']`);
              if(cb) img.style.boxShadow = cb.checked ? "0 0 0 3px rgba(230,0,35,0.12)" : "";
            });
          }

          populateVariantsAndThumbs();
          renderGallery();

          leftBtn.onclick = ()=> { if(!images.length) return; current = (current-1 + images.length) % images.length; renderGallery(); };
          rightBtn.onclick = ()=> { if(!images.length) return; current = (current+1) % images.length; renderGallery(); };
          document.addEventListener("keydown", e=> { if(e.key === "ArrowLeft") leftBtn.click(); if(e.key === "ArrowRight") rightBtn.click(); });

          // ---------- addToCart: sammle ausgewählte Varianten (checkboxes) + Mengen + inches ----------
          document.getElementById("addToCart").addEventListener("click", ()=> {
            const sizeMeasurement = (document.getElementById("inchInput")?.value || "").trim();
            // default qty for main image
            const qty0 = Math.max(1, Number(document.getElementById("qty_0")?.value || 1));
            const selected = Array.from(variantCheckboxes.querySelectorAll("input[type='checkbox']"))
              .filter(cb => cb.checked)
              .map(cb => Number(cb.dataset.index));

            // if none selected, add main (index 0)
            const toAdd = selected.length ? selected : [0];

            toAdd.forEach(idx => {
              const qtyVal = idx === 0 ? qty0 : Math.max(1, Number(document.getElementById(`qty_${idx}`)?.value || 1));
              const item = {
                id: prod.id,
                name: prod.name,
                price: Number(prod.price) || 0,
                variantIndex: idx,
                variantLabel: "Picture " + (idx+1),
                size: sizeMeasurement || "", // this is the inches field stored as 'size' for cart compatibility
                qty: qtyVal,
                image: images[idx] || ""
              };
              addToCart(item);
            });

            alert("Chosen item(s) were added to the cart.");
          });

        })
        .catch(err => {
          console.error("Error while loading:", err);
          document.getElementById("wrap").innerHTML = "<p>Error. Check Code.</p>";
        });
    }

  </script>
</body>
</html>
